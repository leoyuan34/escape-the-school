<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vigilant Orbi — Escape School Obby</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b1020;--panel:#0f1724;--accent:#9ae6b4;--muted:#95a0b3}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:linear-gradient(180deg,#071226,#071226 40%,#0b1220);color:var(--accent);display:flex;gap:16px;height:100vh;padding:20px}
    .left{flex:1;display:flex;flex-direction:column;gap:8px}
    .center{width:720px;max-width:68vw}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:8px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    #screen{width:100%;height:520px;overflow:auto;padding:12px;background:#060812;border-radius:6px;color:#cbd5e1;line-height:1.05;white-space:pre;font-size:14px}
    .hud{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:13px;color:var(--muted)}
    .right{width:320px;display:flex;flex-direction:column;gap:8px}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:6px;color:var(--accent);cursor:pointer}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .upgrades{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .ascii{font-family:ui-monospace,monospace;font-size:12px;line-height:1}
    .footer{font-size:12px;color:var(--muted)}
    .stat{padding:8px;border-radius:6px;background:rgba(255,255,255,0.01)}
    .title{font-weight:700;margin-bottom:8px}
    .big{font-size:18px}
    .log{height:120px;overflow:auto;background:#050812;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)}
    .meter{height:8px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden}
    .meter > i{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4)}
    .kbd{background:#0b1220;padding:6px;border-radius:4px;border:1px dashed rgba(255,255,255,0.02)}
  </style>
</head>
<body>
  <div class="left">
    <div class="panel center">
      <div class="title big">Vigilant Orbi — Escape School Obby</div>
      <div class="small">ASCII obby + incremental upgrades. <b>Modes:</b> Real‑time / Turn‑based. Controls: <span class="kbd">WASD</span>. Jump: <span class="kbd">Space</span>. Pick up <code>k</code>, collect <code>$</code>, reach <code>D</code>.</div>
      <div id="screen" class="ascii"></div>
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
        <button id="btnRestart">Restart Level</button>
        <button id="btnNew">New Run</button>
        <button id="btnMode">Turn‑Based: OFF</button>
        <button id="btnMute">Sound: ON</button>
        <button id="btnSave">Save</button>
        <button id="btnLoad">Load</button>
        <div style="flex:1"></div>
        <div class="footer">Puzzle doors, pressure plates, jumps, enemies, and roguelike progression.</div>
      </div>
    </div>

    <div class="panel hud">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div class="title">Player</div>
          <div class="small">Health <span id="hpText">10</span> / <span id="maxHp">10</span></div>
          <div class="meter" style="width:220px;margin-top:6px"><i id="hpMeter" style="width:100%"></i></div>
        </div>
        <div class="stat">
          <div class="small">Level <span id="levelText">1</span></div>
          <div class="small">XP <span id="xpText">0</span></div>
        </div>
        <div class="stat">
          <div class="small">Coins <span id="coins">0</span></div>
          <div class="small">Keys <span id="keys">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="panel">
      <div class="title">Upgrades (coins)</div>
      <div class="upgrades">
        <button data-upg="speed">Speed +1</button>
        <button data-upg="maxHp">Max HP +2</button>
        <button data-upg="jump">Jump +1</button>
        <button data-upg="sense">Sense</button>
        <button data-upg="magnet">Magnet</button>
        <button data-upg="luck">Luck</button>
      </div>
    </div>

    <div class="panel">
      <div class="title">Log / Events</div>
      <div id="log" class="log small"></div>
    </div>

    <div class="panel">
      <div class="title">Legend</div>
      <div class="small">@ Player E Enemy $ Coin k Key D Door ^ Trap = Pressure Plate ~ Jump Gap</div>
    </div>
  </div>

<script>
// === Audio System (SFX) ===
let soundOn = true;
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
function beep(freq=440,ms=80){
  if(!soundOn) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='square'; o.frequency.value=freq;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+ms/1000);
  o.stop(audioCtx.currentTime+ms/1000);
}

// === Tiles ===
const TILE = {EMPTY:' ', WALL:'#', PLAYER:'@', COIN:'$', KEY:'k', DOOR:'D', TRAP:'^', ENEMY:'E', PLATE:'=', GAP:'~'};

let turnBased = false;

let state = {level:1,map:[],w:32,h:20,player:{x:1,y:1,hp:10,maxHp:10,speed:1,jump:1,luck:0,magnet:0,sense:false},coins:0,keys:0,xp:0,enemies:[],upgrades:{speed:0,maxHp:0,jump:0,sense:0,magnet:0,luck:0}};

const screen=document.getElementById('screen'),logEl=document.getElementById('log'),hpText=document.getElementById('hpText'),hpMeter=document.getElementById('hpMeter'),maxHpText=document.getElementById('maxHp'),levelText=document.getElementById('levelText'),xpText=document.getElementById('xpText'),coinsText=document.getElementById('coins'),keysText=document.getElementById('keys');

function log(msg){logEl.innerText=`[${new Date().toLocaleTimeString()}] ${msg}
`+logEl.innerText}
function rnd(m){return Math.floor(Math.random()*m)}

function findEmpty(){for(let i=0;i<300;i++){let x=1+rnd(state.w-2),y=1+rnd(state.h-2);if(state.map[y][x]===TILE.EMPTY)return{x,y}}}

function newLevel(n){state.level=n;state.w=Math.min(50,24+state.level*2);state.h=Math.min(32,14+state.level*1.2);state.map=Array.from({length:state.h},()=>Array.from({length:state.w},()=>TILE.EMPTY));state.enemies=[];for(let y=0;y<state.h;y++)for(let x=0;x<state.w;x++){if(!x||!y||x===state.w-1||y===state.h-1||Math.random()<0.05)state.map[y][x]=TILE.WALL}state.player.x=1;state.player.y=1;state.map[state.h-2][state.w-2]=TILE.DOOR;for(let i=0;i<8+state.level*2;i++){let p=findEmpty();state.map[p.y][p.x]=TILE.COIN}if(Math.random()<0.8){let p=findEmpty();state.map[p.y][p.x]=TILE.KEY}for(let i=0;i<2+state.level;i++){let p=findEmpty();state.map[p.y][p.x]=TILE.TRAP}
  for(let i=0;i<2+state.level;i++){let p=findEmpty();state.enemies.push({x:p.x,y:p.y,hp:3,dir:Math.random()<.5?1:-1})}
  if(Math.random()<0.5){let p=findEmpty();state.map[p.y][p.x]=TILE.PLATE}
  if(Math.random()<0.7){let p=findEmpty();state.map[p.y][p.x]=TILE.GAP}
  render();log(`Entered Level ${state.level}`)}

function render(){let out='';for(let y=0;y<state.h;y++){for(let x=0;x<state.w;x++){let ch=state.map[y][x];if(state.player.x===x&&state.player.y===y)ch='@';let e=state.enemies.find(e=>e.x===x&&e.y===y);if(e)ch='E';if(ch==='^'&&!state.player.sense)ch=' ';out+=ch}out+='
'}screen.innerText=out;hpText.innerText=state.player.hp;maxHpText.innerText=state.player.maxHp;hpMeter.style.width=(state.player.hp/state.player.maxHp*100)+'%';levelText.innerText=state.level;xpText.innerText=state.xp;coinsText.innerText=state.coins;keysText.innerText=state.keys}

function move(dx,dy){let nx=state.player.x+dx,ny=state.player.y+dy;let t=state.map[ny][nx];if(t===TILE.WALL)return;if(t===TILE.GAP&&state.player.jump<1){log('Gap too wide — upgrade Jump!');return}
  if(t===TILE.COIN){state.coins+=1+state.upgrades.luck;state.map[ny][nx]=' ';beep(880);log('Coin collected')}
  if(t===TILE.KEY){state.keys++;state.map[ny][nx]=' ';beep(660);log('Key found')}
  if(t===TILE.TRAP){state.player.hp--;log('Trap hit!');beep(200)}
  if(t===TILE.PLATE){for(let y=0;y<state.h;y++)for(let x=0;x<state.w;x++)if(state.map[y][x]==='D')state.map[y][x]=' ';log('You opened a door somewhere!')}
  if(t===TILE.DOOR){state.level++;gainXP(25);newLevel(state.level);return}
  state.player.x=nx;state.player.y=ny;enemyTurn();render()}

function enemyTurn(){for(let e of state.enemies){let dx=Math.sign(state.player.x-e.x),dy=Math.sign(state.player.y-e.y);if(Math.random()<0.5)e.x+=dx;else e.y+=dy;if(e.x===state.player.x&&e.y===state.player.y){state.player.hp--;log('Enemy hit you!');beep(120)}}}

function gainXP(n){state.xp+=n;if(state.xp>=100){state.xp=0;state.player.maxHp+=1;state.player.hp=state.player.maxHp;log('LEVEL UP!')}}

window.addEventListener('keydown',e=>{if(e.key==='w')move(0,-1);if(e.key==='s')move(0,1);if(e.key==='a')move(-1,0);if(e.key==='d')move(1,0)});

// UI buttons
btnMode.onclick=()=>{turnBased=!turnBased;btnMode.innerText='Turn‑Based: '+(turnBased?'ON':'OFF')};
btnMute.onclick=()=>{soundOn=!soundOn;btnMute.innerText='Sound: '+(soundOn?'ON':'OFF')};
btnRestart.onclick=()=>newLevel(state.level);
btnNew.onclick=()=>{state.level=1;state.coins=0;state.keys=0;state.xp=0;newLevel(1)};
btnSave.onclick=()=>localStorage.setItem('vo_save',JSON.stringify(state));
btnLoad.onclick=()=>{let s=localStorage.getItem('vo_save');if(s){state=JSON.parse(s);render();log('Loaded save')}};

document.querySelectorAll('[data-upg]').forEach(b=>b.onclick=()=>{let u=b.dataset.upg;let cost=50*(1+state.upgrades[u]);if(state.coins>=cost){state.coins-=cost;state.upgrades[u]++;if(u==='sense')state.player.sense=true;if(u==='jump')state.player.jump++;if(u==='maxHp')state.player.maxHp+=2;if(u==='speed')state.player.speed++;log(`Upgraded ${u}`)}else log('Not enough coins')});

newLevel(1);log('Welcome to Vigilant Orbi 2.0');
</script>
</body>
</html>
